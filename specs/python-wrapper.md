# Python Wrapper Specification

## Overview

TA-Lib provides Python bindings through SWIG (Simplified Wrapper and Interface Generator), a tool that automatically generates language bindings from C/C++ header files. The Python wrapper allows Python applications to call all TA-Lib technical analysis functions with a Pythonic interface.

## Architecture

### SWIG-Based Wrapper System

The Python wrapper uses SWIG to generate Python extension modules from TA-Lib's C API. The wrapper consists of:

1. **SWIG Interface Files**: Define how C types and functions map to Python
2. **Typemaps**: Custom type conversion rules for Python-specific behavior
3. **Generated Python Module**: The final Python extension module

### File Structure

```
swig/
├── src/
│   ├── interface/
│   │   ├── ta_libc.swg          # Main SWIG interface file
│   │   ├── ta_libc.python.swg   # Python-specific typemaps
│   │   ├── ta_func.swg          # Generated function definitions
│   │   └── ta_libc.perl.swg     # Perl typemaps (not used for Python)
│   └── tools/
│       └── test_python/         # Python test suite
└── lib/
    └── python/                  # Generated Python modules location
```

## SWIG Interface Files

### Main Interface File: `ta_libc.swg`

The main SWIG interface file (`swig/src/interface/ta_libc.swg`) includes:

1. **Header Inclusion**: Includes `ta_libc.h` to expose all TA-Lib functions
2. **Language-Specific Typemaps**: Conditionally includes Python typemaps
3. **Type Definitions**: Includes `ta_defs.h` for constants and enums
4. **Function Definitions**: Includes `ta_func.swg` (auto-generated)

Key sections:

```swig
%header %{
#include "ta_libc.h"
%}

#ifdef SWIGPYTHON
  %include "ta_libc.python.swg"
#endif

%include "ta_defs.h"
%include "ta_func.swg"
```

### Generated Function Definitions: `ta_func.swg`

The `ta_func.swg` file is automatically generated by `gen_code` from the abstract layer definitions. It contains SWIG-annotated function signatures for all indicators:

```swig
TA_RetCode TA_ACCBANDS( int           START_IDX,
                        int           END_IDX,
                        const double *IN_ARRAY /* inHigh */,
                        const double *IN_ARRAY /* inLow */,
                        const double *IN_ARRAY /* inClose */,
                        int           OPT_INT /* optInTimePeriod */,
                        int          *BEG_IDX,
                        int          *OUT_SIZE,
                        double       *OUT_ARRAY /* outRealUpperBand */,
                        double       *OUT_ARRAY /* outRealMiddleBand */,
                        double       *OUT_ARRAY /* outRealLowerBand */ );
```

The annotations (`START_IDX`, `IN_ARRAY`, `OPT_INT`, `OUT_ARRAY`, etc.) are typemap placeholders that get replaced with Python-specific conversion code.

## Python Typemaps

### Typemap System

Typemaps define how C types are converted to/from Python types. The Python typemaps are defined in `swig/src/interface/ta_libc.python.swg`.

### Key Typemaps

#### Error Handling: `TA_RetCode`

TA-Lib functions return `TA_RetCode` status codes. The Python wrapper converts these to Python exceptions:

```swig
%typemap(out) TA_RetCode
{
    if( $1 != TA_SUCCESS )
    {
        TA_RetCodeInfo info;
        char text[200];
        TA_SetRetCodeInfo( $1, &info );
        snprintf(text, sizeof(text)-1, "Error %d (%s): %s\n", 
                 $1, info.enumStr, info.infoStr );
        PyErr_SetString(PyExc_Exception, text);
        SWIG_fail;
    } 
    Py_INCREF(Py_None); 
    $result = Py_None;
}
```

If a function returns a non-success code, a Python exception is raised with a descriptive error message.

#### Input Arrays: `IN_ARRAY`

Python lists/tuples are converted to C arrays:

```swig
%typemap(in) const double *IN_ARRAY
{
    int array_size = endIdx2 + 1;
    $1 = ($1_ltype) calloc(array_size, sizeof($*1_ltype));
    if (!convert_darray($input, $1, array_size))  goto fail;
}
```

The `convert_darray` helper function:
- Validates the input is a sequence
- Converts Python floats to C doubles
- Allocates memory for the C array
- Handles array size based on `startIdx` and `endIdx`

#### Optional Parameters: `OPT_INT` and `OPT_REAL`

Optional parameters can be omitted or set to default values:

```swig
%typemap(default) int OPT_INT
    "$1 = TA_INTEGER_DEFAULT;"

%typemap(in) int OPT_INT 
{
    if (PyInt_Check($input)) {
        $1 = ($1_ltype) PyInt_AsLong($input);
    }
}
```

If not provided, parameters default to `TA_INTEGER_DEFAULT` or `TA_REAL_DEFAULT`.

#### Output Arrays: `OUT_ARRAY`

Output arrays are allocated based on the input range and returned as Python lists:

```swig
%typemap(check) double *OUT_ARRAY
{
    int array_size = endIdx2 - startIdx1 + 1;
    $1 = ($1_ltype) calloc(array_size, sizeof($*1_ltype));
}

%typemap(argout) double *OUT_ARRAY
{
    if ( result == TA_SUCCESS ) {
        int idx;
        PyObject *list = PyList_New(outNbElement);
        for (idx = 0; idx < outNbElement; idx++) {
            PyObject *o = PyFloat_FromDouble($1[idx]);
            PyList_SET_ITEM(list,idx,o);
        }
        $result = SWIG_Python_AppendOutput($result, list);
    }
}
```

The output arrays are converted to Python lists and appended to the return tuple.

#### Index Parameters: `START_IDX`, `END_IDX`, `BEG_IDX`

- `START_IDX` and `END_IDX`: Input range parameters (converted from Python integers)
- `BEG_IDX`: Output parameter indicating the first valid output index (returned in tuple)

### Typemap Macros

The wrapper defines several typemap macros for common patterns:

- `STRING_TABLE`: Converts C string tables to Python lists
- `CONST_HANDLE`: Handles const pointer outputs
- `ARRAY_OBJECT`: Handles array members of structs
- `MEMBER_ARRAY`: Converts array members to Python lists

## Python API Mapping

### Function Signature Translation

C function:
```c
TA_RetCode TA_SMA( int    startIdx,
                   int    endIdx,
                   const double *inReal,
                   int    optInTimePeriod,
                   int   *outBegIdx,
                   int   *outNBElement,
                   double *outReal );
```

Python function:
```python
begIdx, outReal = TA_SMA(startIdx, endIdx, inReal, optInTimePeriod)
```

### Return Value Structure

Python functions return a tuple containing:
1. `begIdx`: Index of first valid output (integer)
2. `outReal`: Output array(s) as Python list(s)

For functions with multiple outputs (e.g., BBANDS):
```python
begIdx, upper, middle, lower = TA_BBANDS(
    startIdx, endIdx, inReal, 
    optInTimePeriod, optInNbDevUp, optInNbDevDn, optInMAType
)
```

### Lookback Functions

Lookback functions are exposed directly:
```python
lookback = TA_SMA_Lookback(optInTimePeriod)
```

### Error Handling

Errors are raised as Python exceptions:
```python
try:
    begIdx, result = TA_SMA(0, len(data)-1, data, 5)
except Exception as e:
    print(f"Error: {e}")
```

## Build Process

### Prerequisites

1. **SWIG**: Version 1.3.21 or higher (tested with 1.3.x family)
2. **Python Development Headers**: Required for building extensions
3. **TA-Lib Library**: Must be built and installed first
4. **C Compiler**: Compatible with Python's build system

### Build Steps

The Python wrapper is typically built separately from the main TA-Lib library:

1. **Build TA-Lib**: Compile and install the C library
2. **Run SWIG**: Generate wrapper code from interface files
3. **Compile Extension**: Build Python extension module
4. **Install Module**: Install to Python's site-packages

### Integration with Main Build

The Python wrapper is **not** automatically built by the main CMake/Autotools build system. It must be built separately using SWIG and Python's build tools (distutils/setuptools).

The wrapper is designed to work with:
- Pre-built TA-Lib libraries (shared or static)
- Standard Python packaging tools
- Platform-specific build requirements

## Usage Examples

### Basic Usage

```python
from TaLib import *

# Initialize (optional, done automatically)
TA_Initialize()

# Calculate SMA
data = [91.5, 94.8, 94.4, 95.1, 93.8, 94.6, ...]
begIdx, sma = TA_SMA(0, len(data)-1, data, 20)

# begIdx is the first valid output index
# sma is a list of moving average values
print(f"First valid index: {begIdx}")
print(f"SMA values: {sma[:5]}")
```

### Multiple Outputs

```python
# Bollinger Bands returns 3 arrays
begIdx, upper, middle, lower = TA_BBANDS(
    0, len(data)-1, data,
    20,      # period
    2.0,     # nbDevUp
    2.0,     # nbDevDn
    TA_MAType_SMA
)
```

### Optional Parameters

```python
# Use default period (typically 30)
begIdx, rsi = TA_RSI(0, len(data)-1, data)

# Specify custom period
begIdx, rsi = TA_RSI(0, len(data)-1, data, 14)
```

## Testing

The Python wrapper includes a test suite in `swig/src/tools/test_python/`:

- `ta_func.py`: Tests for technical indicator functions
- `ta_common.py`: Tests for common functions
- `ta_defs.py`: Tests for constants and enums
- `runtests.py`: Test runner

Tests use Python's `unittest` framework and verify:
- Function return values
- Lookback calculations
- Array length correctness
- Error handling

## Limitations and Notes

### Unfinished Features

The `ta_libc.python.swg` file contains several `TODO` comments indicating unfinished typemap implementations:
- `CONST_STRING_TABLE`: Not fully implemented
- `STRING_BUFFER`: Not implemented
- `HANDLE`: Not implemented
- `OBJECT`: Not implemented
- `MEMBER_PTRARRAY`: Not implemented

### Memory Management

- Input arrays are copied to C memory (allocated with `calloc`)
- Output arrays are allocated in C and converted to Python lists
- Memory is automatically freed via `freearg` typemaps
- No manual memory management required from Python code

### Type Support

- **Double arrays**: Fully supported (Python floats → C doubles)
- **Integer arrays**: Supported (Python ints → C ints)
- **Float arrays**: Not supported (raises TypeError)
- **String arrays**: Limited support

### Performance Considerations

- Array conversions involve memory copies
- For large datasets, consider using NumPy arrays (if supported)
- Lookback functions help pre-allocate correct buffer sizes

## Module Structure

The generated Python module (`TaLib`) exposes:

- **All indicator functions**: `TA_SMA`, `TA_RSI`, `TA_MACD`, etc.
- **Lookback functions**: `TA_SMA_Lookback`, etc.
- **Constants**: `TA_SUCCESS`, `TA_MAType_SMA`, etc.
- **Enums**: Moving average types, compatibility modes, etc.
- **Abstract layer functions**: `TA_GroupTableAlloc`, etc. (if needed)

## References

- SWIG Documentation: http://www.swig.org
- Interface Files: `swig/src/interface/`
- Python Typemaps: `swig/src/interface/ta_libc.python.swg`
- Test Suite: `swig/src/tools/test_python/`
- SWIG README: `swig/README.TXT`

